// ============================================
// UIENC 2.0 Internationalization (i18n)
// Multi-language Support System
// ============================================

const translations = {
  en: {
    // Common
    common: {
      loading: "Loading...",
      save: "Save",
      cancel: "Cancel",
      close: "Close",
      edit: "Edit",
      delete: "Delete",
      add: "Add",
      view: "View",
      export: "Export",
      share: "Share",
      search: "Search",
      filter: "Filter",
      sort: "Sort by"
    },
    
    // Navigation
    nav: {
      overview: "Overview",
      growth: "Growth Map",
      projects: "Portfolio",
      badges: "Achievements",
      reflections: "Reflections",
      learners: "Learners",
      analytics: "Analytics",
      progress: "Progress Tracking",
      feedback: "Feedback"
    },
    
    // Dashboard
    dashboard: {
      contributionScore: "Contribution Score",
      learningHours: "Learning Hours",
      completionRate: "Completion Rate",
      activeProjects: "Active Projects",
      totalLearners: "Total Learners",
      avgContribution: "Avg Contribution",
      needsAttention: "Needs Attention"
    },
    
    // Growth Levels
    growth: {
      awakening: "Awakening",
      exploring: "Exploring",
      integrating: "Integrating",
      synthesizing: "Synthesizing",
      transforming: "Transforming"
    },
    
    // Status
    status: {
      excelling: "Excelling",
      onTrack: "On Track",
      needsSupport: "Needs Support",
      completed: "Completed",
      active: "Active",
      inProgress: "In Progress"
    },
    
    // Messages
    messages: {
      dataSaved: "Data saved successfully!",
      projectAdded: "Project added successfully!",
      reflectionAdded: "Reflection added successfully!",
      badgeAwarded: "Badge awarded successfully!",
      exportReady: "Export ready!",
      error: "An error occurred"
    }
  },
  
  hi: {
    // Common
    common: {
      loading: "लोड हो रहा है...",
      save: "सहेजें",
      cancel: "रद्द करें",
      close: "बंद करें",
      edit: "संपादित करें",
      delete: "हटाएं",
      add: "जोड़ें",
      view: "देखें",
      export: "निर्यात करें",
      share: "साझा करें",
      search: "खोजें",
      filter: "फ़िल्टर",
      sort: "क्रमबद्ध करें"
    },
    
    // Navigation
    nav: {
      overview: "अवलोकन",
      growth: "विकास मानचित्र",
      projects: "परियोजनाएं",
      badges: "उपलब्धियां",
      reflections: "चिंतन",
      learners: "शिक्षार्थी",
      analytics: "विश्लेषण",
      progress: "प्रगति ट्रैकिंग",
      feedback: "प्रतिक्रिया"
    },
    
    // Dashboard
    dashboard: {
      contributionScore: "योगदान स्कोर",
      learningHours: "सीखने के घंटे",
      completionRate: "पूर्णता दर",
      activeProjects: "सक्रिय परियोजनाएं",
      totalLearners: "कुल शिक्षार्थी",
      avgContribution: "औसत योगदान",
      needsAttention: "ध्यान चाहिए"
    },
    
    // Growth Levels
    growth: {
      awakening: "जागृति",
      exploring: "अन्वेषण",
      integrating: "एकीकरण",
      synthesizing: "संश्लेषण",
      transforming: "परिवर्तन"
    },
    
    // Status
    status: {
      excelling: "उत्कृष्ट",
      onTrack: "सही दिशा में",
      needsSupport: "सहायता चाहिए",
      completed: "पूर्ण",
      active: "सक्रिय",
      inProgress: "प्रगति में"
    },
    
    // Messages
    messages: {
      dataSaved: "डेटा सफलतापूर्वक सहेजा गया!",
      projectAdded: "परियोजना सफलतापूर्वक जोड़ी गई!",
      reflectionAdded: "चिंतन सफलतापूर्वक जोड़ा गया!",
      badgeAwarded: "बैज सफलतापूर्वक प्रदान किया गया!",
      exportReady: "निर्यात तैयार है!",
      error: "एक त्रुटि हुई"
    }
  },
  
  rongmei: {
    // Common (Rongmei - Tibeto-Burman language)
    common: {
      loading: "Loading...",
      save: "Chamlak",
      cancel: "Kadai",
      close: "Kam",
      edit: "Sut",
      delete: "Thak",
      add: "Piak",
      view: "Mik",
      export: "Thun",
      share: "Pai",
      search: "Kui",
      filter: "Riap",
      sort: "Rum"
    },
    
    // Navigation
    nav: {
      overview: "Kamgan",
      growth: "Kamlu Dau",
      projects: "Kam Gan",
      badges: "Thang Rai",
      reflections: "Lung Thaipai",
      learners: "Tamna Nai",
      analytics: "Riap Dau",
      progress: "Kamlu",
      feedback: "Lung Pai"
    },
    
    // Dashboard
    dashboard: {
      contributionScore: "Pai Khun",
      learningHours: "Tam Hour",
      completionRate: "Kam Sum",
      activeProjects: "Kam Active",
      totalLearners: "Tamna Nai Gan",
      avgContribution: "Pai Khun Rum",
      needsAttention: "Ruangai Kam"
    },
    
    // Growth Levels  
    growth: {
      awakening: "Thaimiu",
      exploring: "Kuimiu",
      integrating: "Chalmiu",
      synthesizing: "Rummiu",
      transforming: "Suimiu"
    },
    
    // Status
    status: {
      excelling: "Aphap",
      onTrack: "Dik",
      needsSupport: "Ruangai",
      completed: "Sum",
      active: "Active",
      inProgress: "Kamlu"
    },
    
    // Messages
    messages: {
      dataSaved: "Data chamlak sum!",
      projectAdded: "Kam piak sum!",
      reflectionAdded: "Lung thaipai piak sum!",
      badgeAwarded: "Thang rai pai sum!",
      exportReady: "Thun ready!",
      error: "Dik dilai"
    }
  },
  
  bn: {
    // Common (Bengali)
    common: {
      loading: "লোড হচ্ছে...",
      save: "সংরক্ষণ করুন",
      cancel: "বাতিল করুন",
      close: "বন্ধ করুন",
      edit: "সম্পাদনা করুন",
      delete: "মুছুন",
      add: "যোগ করুন",
      view: "দেখুন",
      export: "রপ্তানি করুন",
      share: "শেয়ার করুন",
      search: "অনুসন্ধান করুন",
      filter: "ফিল্টার",
      sort: "সাজান"
    },
    
    // Navigation
    nav: {
      overview: "সংক্ষিপ্ত বিবরণ",
      growth: "বৃদ্ধির মানচিত্র",
      projects: "প্রকল্পসমূহ",
      badges: "অর্জনসমূহ",
      reflections: "প্রতিফলন",
      learners: "শিক্ষার্থীরা",
      analytics: "বিশ্লেষণ",
      progress: "অগ্রগতি ট্র্যাকিং",
      feedback: "প্রতিক্রিয়া"
    },
    
    // Dashboard
    dashboard: {
      contributionScore: "অবদান স্কোর",
      learningHours: "শেখার ঘন্টা",
      completionRate: "সমাপ্তির হার",
      activeProjects: "সক্রিয় প্রকল্প",
      totalLearners: "মোট শিক্ষার্থী",
      avgContribution: "গড় অবদান",
      needsAttention: "মনোযোগ প্রয়োজন"
    },
    
    // Growth Levels
    growth: {
      awakening: "জাগরণ",
      exploring: "অন্বেষণ",
      integrating: "একীকরণ",
      synthesizing: "সংশ্লেষণ",
      transforming: "রূপান্তর"
    },
    
    // Status
    status: {
      excelling: "উৎকর্ষ",
      onTrack: "সঠিক পথে",
      needsSupport: "সহায়তা প্রয়োজন",
      completed: "সম্পন্ন",
      active: "সক্রিয়",
      inProgress: "চলমান"
    },
    
    // Messages
    messages: {
      dataSaved: "ডেটা সফলভাবে সংরক্ষিত!",
      projectAdded: "প্রকল্প সফলভাবে যোগ করা হয়েছে!",
      reflectionAdded: "প্রতিফলন সফলভাবে যোগ করা হয়েছে!",
      badgeAwarded: "ব্যাজ সফলভাবে প্রদান করা হয়েছে!",
      exportReady: "রপ্তানি প্রস্তুত!",
      error: "একটি ত্রুটি ঘটেছে"
    }
  }
};

// ===== i18n Class =====
class I18n {
  constructor() {
    this.currentLanguage = this.detectLanguage();
    this.translations = translations;
  }

  // Detect user's preferred language
  detectLanguage() {
    // Check localStorage
    const savedLang = localStorage.getItem('uienc_language');
    if (savedLang && this.translations[savedLang]) {
      return savedLang;
    }

    // Check browser language
    const browserLang = navigator.language.split('-')[0];
    if (this.translations[browserLang]) {
      return browserLang;
    }

    // Default to English
    return 'en';
  }

  // Set language
  setLanguage(lang) {
    if (this.translations[lang]) {
      this.currentLanguage = lang;
      localStorage.setItem('uienc_language', lang);
      this.updateDOM();
      return true;
    }
    return false;
  }

  // Get translation
  t(key) {
    const keys = key.split('.');
    let value = this.translations[this.currentLanguage];

    for (const k of keys) {
      if (value && value[k]) {
        value = value[k];
      } else {
        // Fallback to English
        value = this.translations.en;
        for (const k of keys) {
          if (value && value[k]) {
            value = value[k];
          } else {
            return key; // Return key if not found
          }
        }
        break;
      }
    }

    return value;
  }

  // Update DOM with translations
  updateDOM() {
    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      const translation = this.t(key);
      
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = translation;
      } else {
        element.textContent = translation;
      }
    });

    // Update HTML lang attribute
    document.documentElement.lang = this.currentLanguage;

    // Trigger custom event
    window.dispatchEvent(new CustomEvent('languageChanged', {
      detail: { language: this.currentLanguage }
    }));
  }

  // Get current language
  getCurrentLanguage() {
    return this.currentLanguage;
  }

  // Get available languages
  getAvailableLanguages() {
    return Object.keys(this.translations).map(code => ({
      code,
      name: this.getLanguageName(code)
    }));
  }

  // Get language name
  getLanguageName(code) {
    const names = {
      en: 'English',
      hi: 'हिन्दी (Hindi)',
      rongmei: 'Rongmei',
      bn: 'বাংলা (Bengali)'
    };
    return names[code] || code;
  }

  // Format number based on locale
  formatNumber(number, options = {}) {
    const locales = {
      en: 'en-IN',
      hi: 'hi-IN',
      rongmei: 'en-IN',
      bn: 'bn-IN'
    };
    
    return new Intl.NumberFormat(locales[this.currentLanguage] || 'en-IN', options).format(number);
  }

  // Format date based on locale
  formatDate(date, options = {}) {
    const locales = {
      en: 'en-IN',
      hi: 'hi-IN',
      rongmei: 'en-IN',
      bn: 'bn-IN'
    };
    
    return new Intl.DateTimeFormat(locales[this.currentLanguage] || 'en-IN', options).format(date);
  }
}

// ===== Initialize i18n =====
const i18n = new I18n();

// ===== Language Switcher Component =====
function createLanguageSwitcher() {
  const container = document.createElement('div');
  container.className = 'language-switcher';
  container.innerHTML = `
    <button class="btn btn-icon language-switcher-btn" id="languageSwitcherBtn">
      <i data-lucide="globe"></i>
      <span>${i18n.getCurrentLanguage().toUpperCase()}</span>
    </button>
    <div class="language-dropdown" id="languageDropdown" style="display: none;">
      ${i18n.getAvailableLanguages().map(lang => `
        <button class="language-option ${lang.code === i18n.getCurrentLanguage() ? 'active' : ''}" 
                data-lang="${lang.code}">
          ${lang.name}
        </button>
      `).join('')}
    </div>
  `;
  
  return container;
}

// ===== Add language switcher to page =====
function initLanguageSwitcher() {
  const headerRight = document.querySelector('.header-right');
  if (headerRight) {
    const switcher = createLanguageSwitcher();
    headerRight.insertBefore(switcher, headerRight.firstChild);
    
    // Toggle dropdown
    document.getElementById('languageSwitcherBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = document.getElementById('languageDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      const dropdown = document.getElementById('languageDropdown');
      if (dropdown) dropdown.style.display = 'none';
    });
    
    // Language selection
    document.querySelectorAll('.language-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        i18n.setLanguage(lang);
        location.reload(); // Reload to apply translations
      });
    });
  }
}

// ===== Export =====
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { i18n, I18n, initLanguageSwitcher };
}

// ===== Auto-initialize on DOM load =====
document.addEventListener('DOMContentLoaded', () => {
  // Initialize language switcher
  setTimeout(() => {
    initLanguageSwitcher();
    i18n.updateDOM();
  }, 100);
});

// ===== CSS for Language Switcher =====
const style = document.createElement('style');
style.textContent = `
  .language-switcher {
    position: relative;
    display: inline-block;
  }

  .language-switcher-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem !important;
  }

  .language-switcher-btn span {
    font-size: 0.875rem;
    font-weight: 600;
  }

  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    z-index: 1000;
    overflow: hidden;
  }

  .language-option {
    width: 100%;
    padding: 0.75rem 1rem;
    text-align: left;
    border: none;
    background: white;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.875rem;
  }

  .language-option:hover {
    background: var(--bg-gray);
  }

  .language-option.active {
    background: var(--color-primary);
    color: white;
    font-weight: 600;
  }
`;
document.head.appendChild(style);

console.log('🌐 i18n System initialized:', i18n.getCurrentLanguage());

